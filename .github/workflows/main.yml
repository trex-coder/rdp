name: CI
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:

    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)


    - name: Install Node + LocalTunnel
      run: |
        powershell -Command "iwr https://nodejs.org/dist/v18.17.1/node-v18.17.1-x64.msi -OutFile node.msi"
        msiexec /i node.msi /qn
        npm install -g localtunnel


    - name: Install stunnel
      run: |
        Invoke-WebRequest https://www.stunnel.org/downloads/stunnel-5.71-win64-installer.exe -OutFile stunnel.exe
        Start-Process stunnel.exe -ArgumentList "/silent" -Wait


    - name: Create stunnel config
      run: |
        echo "[RDPHTTPS]" > "C:\Program Files\stunnel\config\rdp.conf"
        echo "client = no" >> "C:\Program Files\stunnel\config\rdp.conf"
        echo "accept = 4433" >> "C:\Program Files\stunnel\config\rdp.conf"
        echo "connect = 127.0.0.1:3389" >> "C:\Program Files\stunnel\config\rdp.conf"

        Start-Process "C:\Program Files\stunnel\bin\stunnel.exe" -ArgumentList "C:\Program Files\stunnel\config\rdp.conf"


    - name: Start LocalTunnel
      shell: powershell
      run: |
        Write-Host "Starting LocalTunnel..."

        Start-Process lt.cmd -ArgumentList "--port 4433 --print-requests" -RedirectStandardOutput lt.log

        $url = $null
        while (-not $url) {
            Start-Sleep 2
            if (Test-Path lt.log) {
                foreach ($line in Get-Content lt.log) {
                    if ($line -match "https://.*\.loca\.lt") {
                        $url = $line.Trim()
                        break
                    }
                }
            }
        }

        Write-Host "=================================="
        Write-Host " Public RDP Tunnel Ready!"
        Write-Host " Connect using ANY HTTPSâ†’TCP bridge tool"
        Write-Host " URL: $url"
        Write-Host " Username: runneradmin"
        Write-Host " Password: P@ssw0rd!"
        Write-Host "=================================="

        # Keep alive
        while ($true) {
            Start-Sleep 30
            Write-Host "Tunnel active at $url"
        }
